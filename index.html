<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор холодных звонков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        /* Стили остаются без изменений */
    </style>
</head>
<body>
    <div id="phone">
        <div id="display"></div>
        <button id="callButton">Начать звонок</button>
    </div>

    <script>
        function initApp() {
            let tg = window.Telegram.WebApp;
            let callButton = document.getElementById('callButton');
            let display = document.getElementById('display');
            let isCallActive = false;
            let intervalId;
            let isTelegramWebApp = tg.initDataUnsafe.query_id !== undefined;

            console.log('Is Telegram WebApp:', isTelegramWebApp);
            logMessage('App initialized. Is Telegram WebApp: ' + isTelegramWebApp);

            tg.expand();

            callButton.addEventListener('click', toggleCall);

            function toggleCall() {
                if (isCallActive) {
                    endCall();
                } else {
                    startCall();
                }
            }

            function startCall() {
                isCallActive = true;
                callButton.textContent = 'Завершить звонок';
                addMessage('Звонок начат.');
                intervalId = setInterval(getResponse, 3000);
                logMessage('Call started');
                if (isTelegramWebApp) {
                    tg.sendData(JSON.stringify({action: 'startCall'}));
                }
            }

            function endCall() {
                isCallActive = false;
                callButton.textContent = 'Начать звонок';
                addMessage('Звонок завершен');
                clearInterval(intervalId);
                logMessage('Call ended');
                if (isTelegramWebApp) {
                    tg.sendData(JSON.stringify({action: 'endCall'}));
                }
            }

            function getResponse() {
                if (isTelegramWebApp) {
                    let responses = [
                        "Здравствуйте, чем могу помочь?",
                        "Интересно, расскажите подробнее.",
                        "А какие преимущества у вашего предложения?",
                        "Сколько это будет стоить?",
                        "Звучит неплохо, но мне нужно подумать.",
                        "У нас уже есть поставщик. Чем ваше предложение лучше?",
                        "Отправьте, пожалуйста, информацию на email.",
                        "Я не принимаю решения по таким вопросам. Обратитесь к моему руководителю.",
                        "Спасибо за информацию, я подумаю над вашим предложением.",
                        "Хорошо, давайте созвонимся на следующей неделе.",
                        "Извините, но мне это не интересно. Всего доброго.",
                    ];
                    let response = responses[Math.floor(Math.random() * responses.length)];
                    addMessage('Собеседник: ' + response);
                    logMessage('Response generated: ' + response);
                    tg.sendData(JSON.stringify({action: 'response', text: response}));
                } else {
                    fetch('http://127.0.0.1:5000/get_response')
                        .then(response => response.json())
                        .then(data => {
                            addMessage('Собеседник: ' + data.response);
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            addMessage('Ошибка при получении ответа');
                        });
                }
            }

            function addMessage(message) {
                display.innerHTML += `<p>${message}</p>`;
                display.scrollTop = display.scrollHeight;
            }

            function logMessage(message) {
                console.log(message);
                if (isTelegramWebApp) {
                    tg.sendData(JSON.stringify({action: 'log', message: message}));
                }
            }

            if (!isTelegramWebApp) {
                testServer();
            }

            function testServer() {
                fetch('http://127.0.0.1:5000/test')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Server test:', data);
                        addMessage('Тест сервера: ' + data.message);
                    })
                    .catch(error => {
                        console.error('Server test error:', error);
                        addMessage('Ошибка при тестировании сервера');
                    });
            }

            tg.ready();
        }

        initApp();
    </script>
</body>
</html>
