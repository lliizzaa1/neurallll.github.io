<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <title>–°–∏–º—É–ª—è—Ç–æ—Ä —Ö–æ–ª–æ–¥–Ω—ã—Ö –∑–≤–æ–Ω–∫–æ–≤</title>
  <script src="https://telegram.org/js/telegram-web-app.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Montserrat:wght@400;700&display=swap');

    body {
      margin: 0;
      display: flex;
      justify-content: center;
      align-items: center;
      min-height: 100vh;
      background: linear-gradient(to bottom, #B0C4DE, #778899);
      font-family: 'Montserrat', sans-serif; 
    }

    .phone {
      width: 400px; 
      height: 900px; 
      border-radius: 40px;
      overflow: hidden;
      box-shadow: 0px 0px 20px rgba(0, 0, 0, 0.2);
      border: 10px solid #A9A9A9;
      position: relative;
      background-color: transparent;
    }

    .wallpaper {
      position: absolute;
      top: 0;
      left: 0;
      width: 100%;
      height: 100%;
      background: linear-gradient(to top, #C0C0C0, #DCDCDC);
      z-index: 1;
    }

    .phone-content { 
      position: relative; 
      z-index: 2; 
      background-color: rgba(255, 255, 255, 0.7);
      width: 100%;
      height: 100%;
      border-radius: 40px; 
    }

    .status-bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 10px 20px;
      color: black;
      font-size: 14px;
    }

    .time {
      font-weight: bold;
    }

    .caller-info {
      text-align: center;
      color: black;
      margin-top: 30px; 
    }

    .caller-name {
      font-size: 24px;
      font-weight: bold;
    }

    .caller-image {
      width: 80px;
      height: 80px;
      margin: 20px auto 10px auto; 
      border-radius: 50%;
      overflow: hidden;
    }

    .caller-image img {
      width: 100%;
      height: 100%;
      object-fit: cover;
    }

    .call-duration {
      font-size: 18px;
      margin-bottom: 10px; 
    }

    .call-button { 
      position: absolute;
      bottom: 20px; 
      left: 50%;
      transform: translateX(-50%);
      background-color: green; 
      border-radius: 50%;
      width: 70px;
      height: 70px;
      display: flex;
      justify-content: center;
      align-items: center;
      box-shadow: 0px 0px 10px rgba(0, 0, 0, 0.2);
      cursor: pointer;
    }

    .call-button img { 
      width: 40px;
      height: 40px;
    }
    
   .sound-wave-container {
      position: absolute;
      width: 240px; 
      height: 100px; 
      left: 50%;
      transform: translateX(-50%);
      bottom: 120px; 
      overflow: hidden; 
      display: flex;
      align-items: center; 
    }

    .sound-wave {
      width: 100%;
      height: 100%;
      display: flex;
      align-items: center;
      justify-content: space-between; 
    }

    .circle {
      width: 15px;
      height: 15px;
      border-radius: 50%;
      background-color: #B0C4DE;
      animation: wave 1.5s infinite ease-in-out; 
    }

    .circle:nth-child(even) {
      animation-delay: .5s; 
    }

    @keyframes wave {
      0%, 100% {
        transform: translateY(0); 
      }
      50% {
        transform: translateY(-20px); 
      }
    }

    .microphone-muted .circle {
      background-color: #D3D3D3; 
      animation-play-state: paused;
    }
    
  </style>
</head>
<body>
  <div class="phone">
    <div class="wallpaper"></div> 
    <div class="phone-content">
      <div class="status-bar">
        <span class="time"></span>
        <span class="signal">
          üì∂
        </span>
      </div>

      <div class="caller-info">
        <div class="caller-name">–ö–ª–∏–µ–Ω—Ç</div>
        <div class="call-duration">00:00</div> 
        <div class="caller-image"></div> 
      </div>

      <div class="sound-wave-container">
        <div class="sound-wave microphone-muted"> 
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
          <div class="circle"></div>
        </div>
      </div>

      <div class="call-button"> 
        <img src="call_start.png" alt="–ù–∞—á–∞—Ç—å –∑–≤–æ–Ω–æ–∫" class="microphone-muted">  
      </div>
    </div>

    <script>
      document.addEventListener('DOMContentLoaded', function() {
        let tg = window.Telegram.WebApp;
        let isCallActive = false;
        let recorder;
        let audioBlob;
        let isRecording = false;
        let silenceTimer;
        let isPlayingResponse = false;
        let silenceDetectionInterval;
        let currentStream; 
        const urlParams = new URLSearchParams(window.location.search);
        const userId = urlParams.get('user_id');

        const callStartSound = new Audio('start_call.mp3'); // –ü—É—Ç—å –∫ –∞—É–¥–∏–æ —Å –≥—É–¥–∫–∞–º–∏ –Ω–∞—á–∞–ª–∞
        const callEndSound = new Audio('end_call.mp3');  

        const SILENCE_THRESHOLD = 1000; 
        let isProcessingRequest = false;
        let audioRequests = [];
        let personCharacteristics; 

        tg.ready();

        const callButton = document.querySelector('.call-button');
        const callDuration = document.querySelector('.call-duration');
        const callerImage = document.querySelector('.caller-image');
        const callButtonImg = callButton.querySelector('img');
        const soundWave = document.querySelector('.sound-wave'); 
        let startTime;
        let callTimer;

        tg.expand();

        callButton.addEventListener('click', toggleCall);

        logMessage('App initialized. Is Telegram WebApp: ' + (tg.initData.query_id !== undefined));

        function toggleCall() {
          if (!isCallActive) {
            callStartSound.play();
            startCall();
            startTime = new Date();
            callTimer = setInterval(updateCallDuration, 1000);
          } else {
            callEndSound.play();
            endCall();
            clearInterval(callTimer);
            callDuration.textContent = '00:00';
          }
          isCallActive = !isCallActive; 
        }

        async function startCall() {
          callButton.style.backgroundColor = 'red'; 
          callButtonImg.src = 'call_end.png'; 
          addMessage('–ó–≤–æ–Ω–æ–∫ –Ω–∞—á–∞—Ç', 'system');
          personCharacteristics = await generatePersonCharacteristics();
          console.log("–°–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞–Ω–Ω—ã–µ —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏:", personCharacteristics); 

          navigator.mediaDevices.getUserMedia({ audio: true })
            .then(stream => {
              currentStream = stream;
              initializeRecorder(stream);
              startSilenceDetection(stream);
            })
            .catch(error => {
              console.error('Error accessing the microphone:', error);
              addMessage('–û—à–∏–±–∫–∞: –ù–µ —É–¥–∞–ª–æ—Å—å –ø–æ–ª—É—á–∏—Ç—å –¥–æ—Å—Ç—É–ø –∫ –º–∏–∫—Ä–æ—Ñ–æ–Ω—É', 'error');
              endCall();
            });
        }

        function endCall() {
          callButton.style.backgroundColor = 'green';
          callButtonImg.src = 'call_start.png';
          addMessage('–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω', 'system');
          logMessage('Call ended');
          if (tg.initData.query_id !== undefined) {
            tg.sendData(JSON.stringify({ action: 'endCall' }));
          }

          if (silenceTimer) {
            clearTimeout(silenceTimer);
            silenceTimer = null;
          }

          if (silenceDetectionInterval) {
            clearInterval(silenceDetectionInterval);
            silenceDetectionInterval = null;
          }

          deleteConversation();

          if (isRecording) {
            stopRecordingAndSend(personCharacteristics); 
          }
        }

        function resumeListening() {
          if (isCallActive && !isRecording && !isPlayingResponse) { 
            console.log("–í–æ–∑–æ–±–Ω–æ–≤–ª—è–µ–º –ø—Ä–æ—Å–ª—É—à–∏–≤–∞–Ω–∏–µ");
            initializeRecorder(currentStream);
            startSilenceDetection(currentStream);
          }
        }

        function startRecording() {
          isRecording = true;
          recorder.startRecording();
          soundWave.classList.remove('microphone-muted'); 
          console.log("–ó–∞–ø–∏—Å—å –Ω–∞—á–∞—Ç–∞");
        }

        function initializeRecorder(stream) {
          recorder = new RecordRTC(stream, {
            type: 'audio',
            mimeType: 'audio/wav',
            recorderType: RecordRTC.StereoAudioRecorder 
          });
        }

        function stopRecordingAndSend(personCharacteristics) {
          isRecording = false;
          recorder.stopRecording(() => {
            audioBlob = recorder.getBlob();
            sendAudioToServer(audioBlob, personCharacteristics);
          });
          console.log("–ó–∞–ø–∏—Å—å –æ—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∞, –æ—Ç–ø—Ä–∞–≤–∫–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä");
        }

        async function sendAudioToServer(audioBlob, personCharacteristics) {
          if (isProcessingRequest) { 
            console.log("–ü—Ä–µ–¥—ã–¥—É—â–∏–π –∑–∞–ø—Ä–æ—Å –µ—â–µ –æ–±—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç—Å—è.");
            return; 
          }

          isProcessingRequest = true; 
          soundWave.classList.add('microphone-muted');

          const formData = new FormData();
          formData.append('audio', audioBlob, 'recording.wav');

          const requestId = Date.now();
          audioRequests.push({ id: requestId, characteristics: personCharacteristics });
          formData.append('requestId', requestId);

          if (personCharacteristics) { 
            formData.append('characteristics', JSON.stringify(personCharacteristics));
          }

          if (userId) {
            formData.append('telegram_user_id', userId);
          } else {
            console.error("–û—à–∏–±–∫–∞: userId –Ω–µ –æ–ø—Ä–µ–¥–µ–ª–µ–Ω");
          }

          try {
            clearInterval(silenceDetectionInterval);
            console.log("–û—Ç–ø—Ä–∞–≤–∫–∞ –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä...");
            const response = await fetch('http://127.0.0.1:5000/recognize_speech', { 
              method: 'POST',
              body: formData
            });

            console.log("–ü–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞. –°—Ç–∞—Ç—É—Å:", response.status);

            if (!response.ok) {
              const errorText = await response.text();
              throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
            }

            const data = await response.json();
            console.log("–£—Å–ø–µ—à–Ω–æ –ø–æ–ª—É—á–µ–Ω –æ—Ç–≤–µ—Ç –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞:", data);

            const requestIndex = audioRequests.findIndex(req => req.id === data.requestId);
            if (requestIndex !== -1) {
              console.log("–•–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫–∏ –∏–∑ –∑–∞–ø—Ä–æ—Å–∞:", audioRequests[requestIndex].characteristics);
              audioRequests.splice(requestIndex, 1);
            } else {
              console.error("–ó–∞–ø—Ä–æ—Å –Ω–µ –Ω–∞–π–¥–µ–Ω:", data.requestId);
            }

            if (data.audio_data) {
              try {
                console.log("–ü–æ–ø—ã—Ç–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç–∞...");

                const audio = new Audio();
                audio.src = data.audio_data;

                isPlayingResponse = true; 

                audio.oncanplaythrough = () => {
                  console.log("–ê—É–¥–∏–æ –≥–æ—Ç–æ–≤–æ –∫ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—é");
                  audio.playbackRate = 2;
                  audio.play().catch(error => {
                    console.error("–û—à–∏–±–∫–∞ –≤–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏—è –∞—É–¥–∏–æ:", error);
                    isPlayingResponse = false; 
                    resumeListening(); 
                  });
                };

                audio.onended = () => {
                  startSilenceDetection(currentStream);
                  console.log("–í–æ—Å–ø—Ä–æ–∏–∑–≤–µ–¥–µ–Ω–∏–µ –∞—É–¥–∏–æ –æ—Ç–≤–µ—Ç–∞ –∑–∞–≤–µ—Ä—à–µ–Ω–æ");
                  isPlayingResponse = false; 
                  resumeListening(); 
                };

                audio.onerror = (e) => {
                  console.error("–û—à–∏–±–∫–∞ –∑–∞–≥—Ä—É–∑–∫–∏ –∞—É–¥–∏–æ:", e);
                  isPlayingResponse = false; 
                  resumeListening(); 
                };
              } catch (urlError) {
                console.error("–ù–µ–∫–æ—Ä—Ä–µ–∫—Ç–Ω—ã–π URL –∞—É–¥–∏–æ –¥–∞–Ω–Ω—ã—Ö:", urlError);
                resumeListening(); 
              }
            } else {
              startSilenceDetection(currentStream);
              console.log("–ê—É–¥–∏–æ –¥–∞–Ω–Ω—ã–µ –æ—Ç—Å—É—Ç—Å—Ç–≤—É—é—Ç –≤ –æ—Ç–≤–µ—Ç–µ —Å–µ—Ä–≤–µ—Ä–∞");
              resumeListening(); 
            }
          } catch (error) {
            console.error('–û—à–∏–±–∫–∞ –æ—Ç–ø—Ä–∞–≤–∫–∏ –∞—É–¥–∏–æ –Ω–∞ —Å–µ—Ä–≤–µ—Ä:', error);
            resumeListening(); 
          } finally {
            isProcessingRequest = false; 
          }
        }        

        function addMessage(message, type) {
          
        }
        
        function logMessage(message) {
          console.log(message);
          if (tg.initData.query_id !== undefined) { 
            tg.sendData(JSON.stringify({action: 'log', message: message}));
          }
        }

        function getRandomInt(min, max) {
          return Math.floor(Math.random() * (max - min + 1)) + min;
        }
        
        function getRandomElement(array) {
          return array[getRandomInt(0, array.length - 1)];
        }
        
        function generatePersonCharacteristics() {
          const characteristics = {
            "–ø–æ–ª": getRandomElement(["–ú—É–∂—Å–∫–æ–π", "–ñ–µ–Ω—Å–∫–∏–π"]),
            "—É—Ä–æ–≤–µ–Ω—å_–¥–æ—Ö–æ–¥–∞": getRandomElement([
              "–ù–∏–∑–∫–∏–π (–¥–æ 30 000 —Ä—É–±/–º–µ—Å)",
              "–ù–∏–∂–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (30 000 - 50 000 —Ä—É–±/–º–µ—Å)",
              "–°—Ä–µ–¥–Ω–∏–π (50 000 - 100 000 —Ä—É–±/–º–µ—Å)",
              "–í—ã—à–µ —Å—Ä–µ–¥–Ω–µ–≥–æ (100 000 - 200 000 —Ä—É–±/–º–µ—Å)",
              "–í—ã—Å–æ–∫–∏–π (200 000 - 500 000 —Ä—É–±/–º–µ—Å)",
              "–û—á–µ–Ω—å –≤—ã—Å–æ–∫–∏–π (–±–æ–ª–µ–µ 500 000 —Ä—É–±/–º–µ—Å)"
            ]),
            "–ø—Ä–æ—Ñ–µ—Å—Å–∏—è": getRandomElement([
              "IT-—Å–ø–µ—Ü–∏–∞–ª–∏—Å—Ç", "–í—Ä–∞—á", "–£—á–∏—Ç–µ–ª—å", "–ò–Ω–∂–µ–Ω–µ—Ä", "–ú–µ–Ω–µ–¥–∂–µ—Ä", "–ü—Ä–µ–¥–ø—Ä–∏–Ω–∏–º–∞—Ç–µ–ª—å", 
              "–Æ—Ä–∏—Å—Ç", "–ë—É—Ö–≥–∞–ª—Ç–µ—Ä", "–ü—Ä–æ–¥–∞–≤–µ—Ü", "–°—Ç—Ä–æ–∏—Ç–µ–ª—å", "–í–æ–¥–∏—Ç–µ–ª—å", 
              "–†–∞–±–æ—Ç–Ω–∏–∫ —Å—Ñ–µ—Ä—ã —É—Å–ª—É–≥", "–ì–æ—Å—É–¥–∞—Ä—Å—Ç–≤–µ–Ω–Ω—ã–π —Å–ª—É–∂–∞—â–∏–π", "–í–æ–µ–Ω–Ω–æ—Å–ª—É–∂–∞—â–∏–π", 
              "–ü–µ–Ω—Å–∏–æ–Ω–µ—Ä", "–°—Ç—É–¥–µ–Ω—Ç"
            ]),
            "—Å–µ–º–µ–π–Ω–æ–µ_–ø–æ–ª–æ–∂–µ–Ω–∏–µ": getRandomElement([
              "–•–æ–ª–æ—Å—Ç/–Ω–µ –∑–∞–º—É–∂–µ–º", "–ñ–µ–Ω–∞—Ç/–∑–∞–º—É–∂–µ–º", "–í —Ä–∞–∑–≤–æ–¥–µ", "–í–¥–æ–≤–µ—Ü/–≤–¥–æ–≤–∞", "–í –≥—Ä–∞–∂–¥–∞–Ω—Å–∫–æ–º –±—Ä–∞–∫–µ"
            ]),
            "–¥–µ—Ç–∏": getRandomElement([
              "–ù–µ—Ç –¥–µ—Ç–µ–π", "1 —Ä–µ–±–µ–Ω–æ–∫", "2 –¥–µ—Ç–µ–π", "3 –¥–µ—Ç–µ–π", "4 –∏ –±–æ–ª–µ–µ –¥–µ—Ç–µ–π"
            ]),
            "–æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ": getRandomElement([
              "–°—Ä–µ–¥–Ω–µ–µ", "–°—Ä–µ–¥–Ω–µ–µ —Å–ø–µ—Ü–∏–∞–ª—å–Ω–æ–µ", "–ù–µ–æ–∫–æ–Ω—á–µ–Ω–Ω–æ–µ –≤—ã—Å—à–µ–µ", "–í—ã—Å—à–µ–µ", 
              "–ù–µ—Å–∫–æ–ª—å–∫–æ –≤—ã—Å—à–∏—Ö –æ–±—Ä–∞–∑–æ–≤–∞–Ω–∏–π", "–£—á–µ–Ω–∞—è —Å—Ç–µ–ø–µ–Ω—å"
            ]),
            "—Ä–µ–≥–∏–æ–Ω": getRandomElement([
              "–ú–æ—Å–∫–≤–∞", "–°–∞–Ω–∫—Ç-–ü–µ—Ç–µ—Ä–±—É—Ä–≥", "–¶–µ–Ω—Ç—Ä–∞–ª—å–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", "–°–µ–≤–µ—Ä–æ-–ó–∞–ø–∞–¥–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", 
              "–Æ–∂–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", "–°–µ–≤–µ—Ä–æ-–ö–∞–≤–∫–∞–∑—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", "–ü—Ä–∏–≤–æ–ª–∂—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", 
              "–£—Ä–∞–ª—å—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", "–°–∏–±–∏—Ä—Å–∫–∏–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥", "–î–∞–ª—å–Ω–µ–≤–æ—Å—Ç–æ—á–Ω—ã–π —Ñ–µ–¥–µ—Ä–∞–ª—å–Ω—ã–π –æ–∫—Ä—É–≥"
            ]),
            "–∂–∏–ª—å–µ": getRandomElement([
              "–°–æ–±—Å—Ç–≤–µ–Ω–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞", "–°–æ–±—Å—Ç–≤–µ–Ω–Ω—ã–π –¥–æ–º", "–°—ä–µ–º–Ω–∞—è –∫–≤–∞—Ä—Ç–∏—Ä–∞", "–°—ä–µ–º–Ω—ã–π –¥–æ–º", 
              "–ö–æ–º–Ω–∞—Ç–∞ –≤ –æ–±—â–µ–∂–∏—Ç–∏–∏", "–ñ–∏–≤–µ—Ç —Å —Ä–æ–¥–∏—Ç–µ–ª—è–º–∏"
            ]),
            "–æ–ø—ã—Ç_–∏–Ω–≤–µ—Å—Ç–∏—Ä–æ–≤–∞–Ω–∏—è": getRandomElement([
              "–ù–æ–≤–∏—á–æ–∫ (–Ω–µ—Ç –æ–ø—ã—Ç–∞)", "–ù–∞—á–∏–Ω–∞—é—â–∏–π (–º–µ–Ω–µ–µ 1 –≥–æ–¥–∞)", "–°—Ä–µ–¥–Ω–∏–π (1-3 –≥–æ–¥–∞)", 
              "–û–ø—ã—Ç–Ω—ã–π (3-5 –ª–µ—Ç)", "–≠–∫—Å–ø–µ—Ä—Ç (–±–æ–ª–µ–µ 5 –ª–µ—Ç)"
            ]),
            "–æ—Ç–Ω–æ—à–µ–Ω–∏–µ_–∫_—Ä–∏—Å–∫—É": getRandomElement([
              "–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π", "–£–º–µ—Ä–µ–Ω–Ω–æ-–∫–æ–Ω—Å–µ—Ä–≤–∞—Ç–∏–≤–Ω—ã–π", "–°–±–∞–ª–∞–Ω—Å–∏—Ä–æ–≤–∞–Ω–Ω—ã–π", "–£–º–µ—Ä–µ–Ω–Ω–æ-–∞–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π", "–ê–≥—Ä–µ—Å—Å–∏–≤–Ω—ã–π"
            ]),
            "—Ü–µ–ª–∏": getRandomElement([
              "–ù–∞–∫–æ–ø–ª–µ–Ω–∏–µ –Ω–∞ –ø–µ–Ω—Å–∏—é", "–ü–æ–∫—É–ø–∫–∞ –Ω–µ–¥–≤–∏–∂–∏–º–æ—Å—Ç–∏", "–û–±—Ä–∞–∑–æ–≤–∞–Ω–∏–µ –¥–µ—Ç–µ–π", 
              "–°–æ–∑–¥–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤–æ–π –ø–æ–¥—É—à–∫–∏ –±–µ–∑–æ–ø–∞—Å–Ω–æ—Å—Ç–∏", "–ü–æ–ª—É—á–µ–Ω–∏–µ –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –¥–æ—Ö–æ–¥–∞", 
              "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–ü–æ–∫—É–ø–∫–∞ –∞–≤—Ç–æ–º–æ–±–∏–ª—è", "–û—Ç–∫—Ä—ã—Ç–∏–µ –±–∏–∑–Ω–µ—Å–∞"
            ]),
            "—Ö–æ–±–±–∏": getRandomElement([
              "–°–ø–æ—Ä—Ç", "–ß—Ç–µ–Ω–∏–µ", "–ü—É—Ç–µ—à–µ—Å—Ç–≤–∏—è", "–ö—É–ª–∏–Ω–∞—Ä–∏—è", "–†—ã–±–∞–ª–∫–∞/–æ—Ö–æ—Ç–∞", "–°–∞–¥–æ–≤–æ–¥—Å—Ç–≤–æ", 
              "–§–æ—Ç–æ–≥—Ä–∞—Ñ–∏—è", "–ú—É–∑—ã–∫–∞", "–ò—Å–∫—É—Å—Å—Ç–≤–æ", "–ö–æ–º–ø—å—é—Ç–µ—Ä–Ω—ã–µ –∏–≥—Ä—ã", "–†—É–∫–æ–¥–µ–ª–∏–µ", 
              "–ö–æ–ª–ª–µ–∫—Ü–∏–æ–Ω–∏—Ä–æ–≤–∞–Ω–∏–µ", "–í–æ–ª–æ–Ω—Ç–µ—Ä—Å—Ç–≤–æ"
            ]),
            "—Ç–µ–º–ø–µ—Ä–∞–º–µ–Ω—Ç": getRandomElement([
              "–•–æ–ª–µ—Ä–∏–∫", "–°–∞–Ω–≥–≤–∏–Ω–∏–∫", "–§–ª–µ–≥–º–∞—Ç–∏–∫", "–ú–µ–ª–∞–Ω—Ö–æ–ª–∏–∫"
            ]),
            "–∑–∞–Ω—è—Ç–æ—Å—Ç—å": getRandomElement([
              "–û—á–µ–Ω—å –∑–∞–Ω—è—Ç (–º–µ–Ω–µ–µ 1 —á–∞—Å–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –¥–µ–Ω—å)", 
              "–ó–∞–Ω—è—Ç (1-2 —á–∞—Å–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –¥–µ–Ω—å)", 
              "–°—Ä–µ–¥–Ω—è—è –∑–∞–Ω—è—Ç–æ—Å—Ç—å (2-4 —á–∞—Å–∞ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ –≤ –¥–µ–Ω—å)", 
              "–ú–Ω–æ–≥–æ —Å–≤–æ–±–æ–¥–Ω–æ–≥–æ –≤—Ä–µ–º–µ–Ω–∏ (–±–æ–ª–µ–µ 4 —á–∞—Å–æ–≤ –≤ –¥–µ–Ω—å)", 
              "–ë–µ–∑—Ä–∞–±–æ—Ç–Ω—ã–π/–≤ –ø–æ–∏—Å–∫–µ —Ä–∞–±–æ—Ç—ã"
            ]),
            "–∫–æ–º–º—É–Ω–∏–∫–∞—Ü–∏—è_–ø—Ä–µ–¥–ø–æ—á–∏—Ç–∞–µ–º–∞—è": getRandomElement([
              "–¢–µ–ª–µ—Ñ–æ–Ω–Ω—ã–µ –∑–≤–æ–Ω–∫–∏", "Email", "WhatsApp", "Telegram", "Viber", "SMS", "–õ–∏—á–Ω—ã–µ –≤—Å—Ç—Ä–µ—á–∏"
            ]),
            "–æ—Ç–Ω–æ–µ—à–µ–Ω–∏–µ_–∫_—Ç–µ—Ö–Ω–æ–ª–æ–≥–∏—è–º": getRandomElement([
              "–¢–µ—Ö–Ω–æ—Ñ–æ–± (–∏–∑–±–µ–≥–∞–µ—Ç –Ω–æ–≤—ã—Ö —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π)", "–ö–æ–Ω—Å–µ—Ä–≤–∞—Ç–æ—Ä (–∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Ç–æ–ª—å–∫–æ –ø—Ä–æ–≤–µ—Ä–µ–Ω–Ω—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)", 
              "–£–º–µ—Ä–µ–Ω–Ω—ã–π –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—å (–æ—Ç–∫—Ä—ã—Ç –∫ –Ω–æ–≤–æ–º—É, –Ω–æ –æ—Å—Ç–æ—Ä–æ–∂–µ–Ω)", "–≠–Ω—Ç—É–∑–∏–∞—Å—Ç (–∞–∫—Ç–∏–≤–Ω–æ –∏—Å–ø–æ–ª—å–∑—É–µ—Ç –Ω–æ–≤—ã–µ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–∏)", 
              "–†–∞–Ω–Ω–∏–π –ø–æ—Å–ª–µ–¥–æ–≤–∞—Ç–µ–ª—å (–≤—Å–µ–≥–¥–∞ –≤ –∫—É—Ä—Å–µ –ø–æ—Å–ª–µ–¥–Ω–∏—Ö –Ω–æ–≤–∏–Ω–æ–∫)"
            ]),
            "–∫—Ä–µ–¥–∏—Ç–Ω–∞—è_–∏—Å—Ç–æ—Ä–∏—è": getRandomElement([
              "–û—Ç–ª–∏—á–Ω–∞—è (–≤—Å–µ–≥–¥–∞ –≤–æ–≤—Ä–µ–º—è –ø–æ–≥–∞—à–∞–µ—Ç –∫—Ä–µ–¥–∏—Ç—ã)", "–•–æ—Ä–æ—à–∞—è (—Ä–µ–¥–∫–∏–µ –∑–∞–¥–µ—Ä–∂–∫–∏ –ø–ª–∞—Ç–µ–∂–µ–π)", "–°—Ä–µ–¥–Ω—è—è (–±—ã–≤–∞—é—Ç –ø—Ä–æ—Å—Ä–æ—á–∫–∏)", 
              "–ü–ª–æ—Ö–∞—è (–µ—Å—Ç—å –Ω–µ–ø–æ–≥–∞—à–µ–Ω–Ω—ã–µ –∫—Ä–µ–¥–∏—Ç—ã)", "–û—Ç—Å—É—Ç—Å—Ç–≤—É–µ—Ç (–Ω–∏–∫–æ–≥–¥–∞ –Ω–µ –±—Ä–∞–ª –∫—Ä–µ–¥–∏—Ç—ã)"
            ]),
            "—Å–±–µ—Ä–µ–∂–µ–Ω–∏—è": getRandomElement([
              "–ù–µ—Ç —Å–±–µ—Ä–µ–∂–µ–Ω–∏–π", "–ú–∏–Ω–∏–º–∞–ª—å–Ω—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è (–¥–æ 50 000 —Ä—É–±)", "–°—Ä–µ–¥–Ω–∏–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è (50 000 - 300 000 —Ä—É–±)", 
              "–ó–Ω–∞—á–∏—Ç–µ–ª—å–Ω—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è (300 000 - 1 000 000 —Ä—É–±)", "–ö—Ä—É–ø–Ω—ã–µ —Å–±–µ—Ä–µ–∂–µ–Ω–∏—è (–±–æ–ª–µ–µ 1 000 000 —Ä—É–±)"
            ]),
            "—É—Ä–æ–≤–µ–Ω—å_–∑–Ω–∞–Ω–∏–π_–≤_–æ–±–ª–∞—Å—Ç–∏_—Ñ–∏–Ω–∞–Ω—Å–æ–≤": getRandomElement([
              "–ù–∏–∑–∫–æ–µ (–∑–Ω–∞–µ—Ç —Ç–æ–ª—å–∫–æ –æ –≤–∫–ª–∞–¥–∞—Ö)", "–ë–∞–∑–æ–≤–æ–µ (–∑–Ω–∞–µ—Ç –æ –≤–∫–ª–∞–¥–∞—Ö –∏ –∫—Ä–µ–¥–∏—Ç–∞—Ö)", 
              "–°—Ä–µ–¥–Ω–µ–µ (–∑–Ω–∞–µ—Ç –æ –≤–∫–ª–∞–¥–∞—Ö, –∫—Ä–µ–¥–∏—Ç–∞—Ö, –∞–∫—Ü–∏—è—Ö –∏ –æ–±–ª–∏–≥–∞—Ü–∏—è—Ö)", 
              "–í—ã—Å–æ–∫–æ–µ (—Ä–∞–∑–±–∏—Ä–∞–µ—Ç—Å—è –≤ –±–æ–ª—å—à–∏–Ω—Å—Ç–≤–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö –∏–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç–æ–≤)", 
              "–≠–∫—Å–ø–µ—Ä—Ç–Ω–æ–µ (–≥–ª—É–±–æ–∫–æ–µ –ø–æ–Ω–∏–º–∞–Ω–∏–µ —Ñ–∏–Ω–∞–Ω—Å–æ–≤—ã—Ö —Ä—ã–Ω–∫–æ–≤)"
            ]),
            "–æ–ø—ã—Ç_—Å_–∫–æ–º–ø–∞–Ω–∏—è–º–∏": getRandomElement([
              "–ù–µ—Ç –æ–ø—ã—Ç–∞", "–ù–µ–≥–∞—Ç–∏–≤–Ω—ã–π –æ–ø—ã—Ç", "–ù–µ–π—Ç—Ä–∞–ª—å–Ω—ã–π –æ–ø—ã—Ç", "–ü–æ–∑–∏—Ç–∏–≤–Ω—ã–π –æ–ø—ã—Ç", 
              "–°–º–µ—à–∞–Ω–Ω—ã–π –æ–ø—ã—Ç (–∏ –ø–æ–∑–∏—Ç–∏–≤–Ω—ã–π, –∏ –Ω–µ–≥–∞—Ç–∏–≤–Ω—ã–π)"
            ]),
            "–ø—Å–∏—Ö–æ–ª–æ–≥–∏—á–µ—Å–∫–∏–π_–ø–æ—Ä—Ç—Ä–µ—Ç": getRandomElement([
              "–û—Ç–∫—Ä—ã—Ç–æ—Å—Ç—å –Ω–æ–≤–æ–º—É", "–°–∫–µ–ø—Ç–∏—Ü–∏–∑–º", "–ò–º–ø—É–ª—å—Å–∏–≤–Ω–æ—Å—Ç—å", "–û—Å—Ç–æ—Ä–æ–∂–Ω–æ—Å—Ç—å", 
              "–ê–Ω–∞–ª–∏—Ç–∏—á–µ—Å–∫–∏–π —Å–∫–ª–∞–¥ —É–º–∞", "–≠–º–æ—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å", "–†–∞—Ü–∏–æ–Ω–∞–ª—å–Ω–æ—Å—Ç—å", 
              "–°–∫–ª–æ–Ω–Ω–æ—Å—Ç—å –∫ –ø—Ä–æ–∫—Ä–∞—Å—Ç–∏–Ω–∞—Ü–∏–∏", "–†–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", "–ù–µ—Ä–µ—à–∏—Ç–µ–ª—å–Ω–æ—Å—Ç—å", 
              "–°—Ç—Ä–µ—Å—Å–æ—É—Å—Ç–æ–π—á–∏–≤–æ—Å—Ç—å", "–ü–µ—Ä—Ñ–µ–∫—Ü–∏–æ–Ω–∏–∑–º"
            ])
          };

          const gender = getRandomElement(["man", "woman"]); 
          characteristics.gender = gender; 

          callerImage.innerHTML = `<img src="${gender}.png" alt="${gender}">`;

          return characteristics;
        }

        async function deleteConversation() {
          const formData = new FormData();
          formData.append('telegram_user_id', userId); 

          try {
            const response = await fetch('http://127.0.0.1:5000/delete_conversation', {
              method: 'POST',
              body: formData
            });

            if (response.ok) {
              console.log('Conversation deleted successfully');
            } else {
              console.error('Error deleting conversation:', response.status);
            }
          } catch (error) {
            console.error('Error deleting conversation:', error);
          }
        }

        function startSilenceDetection(stream) {
          const audioContext = new AudioContext();
          const analyser = audioContext.createAnalyser();
          const microphone = audioContext.createMediaStreamSource(stream);
          microphone.connect(analyser);
          analyser.fftSize = 2048;
          const bufferLength = analyser.frequencyBinCount;
          const dataArray = new Uint8Array(bufferLength);

          let silenceStart = null;
          const SILENCE_DURATION = 1000; 
          const NOISE_THRESHOLD = 10; 

          function checkSilence() {
            if (!isCallActive) {
              console.log("–ó–≤–æ–Ω–æ–∫ –∑–∞–≤–µ—Ä—à–µ–Ω, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –ø—Ä–æ–≤–µ—Ä–∫—É —Ç–∏—à–∏–Ω—ã");
              clearInterval(silenceDetectionInterval);
              return;
            }

            if (isPlayingResponse) { 
              return;
            }

            analyser.getByteFrequencyData(dataArray);
            const average = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;

            if (average < NOISE_THRESHOLD) {
              if (!silenceStart) {
                silenceStart = Date.now();
              } else if (Date.now() - silenceStart > SILENCE_DURATION && !isPlayingResponse) { 
                if (isRecording) {
                  console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω–∞ —Ç–∏—à–∏–Ω–∞, –æ—Å—Ç–∞–Ω–∞–≤–ª–∏–≤–∞–µ–º –∑–∞–ø–∏—Å—å");
                  stopRecordingAndSend(personCharacteristics);  
                  silenceStart = null; 
                }
              }
            } else {
              silenceStart = null;
              if (!isRecording && !isPlayingResponse) { 
                console.log("–û–±–Ω–∞—Ä—É–∂–µ–Ω –∑–≤—É–∫, –Ω–∞—á–∏–Ω–∞–µ–º –∑–∞–ø–∏—Å—å");
                startRecording(); 
              }
            }
          }

          silenceDetectionInterval = setInterval(checkSilence, 100); 
        }

        function updateCallDuration() {
          const now = new Date();
          const elapsed = Math.floor((now - startTime) / 1000);
          const minutes = Math.floor(elapsed / 60);
          const seconds = elapsed % 60;
          callDuration.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
        }
        
        function updateTime() {
          const now = new Date();
          const timeString = now.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
          document.querySelector('.time').textContent = timeString;
        }

        updateTime();
        setInterval(updateTime, 1000);

      });
    </script>
  </div>
</body>
</html>
