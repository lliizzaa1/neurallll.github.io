<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор холодных звонков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #phone {
            width: 300px;
            height: 600px;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #display {
            width: 100%;
            height: 400px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        #display p {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
            max-width: 80%;
        }
        #display p.system {
            background-color: var(--tg-theme-secondary-bg-color, #e6e6e6);
            align-self: center;
            text-align: center;
            font-style: italic;
        }
        #display p.response {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            align-self: flex-start;
        }
        #display p.user {
            background-color: var(--tg-theme-secondary-bg-color, #e6e6e6);
            align-self: flex-end;
            text-align: right;
        }
        #display p.error {
            background-color: #ff4d4d;
            color: white;
            align-self: center;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--tg-theme-secondary-bg-color, #2980b9);
        }
    </style>
</head>
<body>
    <div id="phone">
        <div id="display">
            <p id="recordingStatus"></p> 
        </div> 
        <button id="callButton">Начать звонок</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let tg = window.Telegram.WebApp;
            let callButton = document.getElementById('callButton');
            let display = document.getElementById('display');
            let isCallActive = false;
            let recorder;
            let audioBlob;
            let isRecording = false;
            let silenceTimer;
            let isPlayingResponse = false;
            let silenceDetectionInterval;
            let currentStream; 

            const SILENCE_THRESHOLD = 1000; // 1 секунда тишины

            // Инициализация Telegram Mini App
            tg.ready();
            
            // Обработчик нажатия на кнопку "Начать звонок"
            callButton.addEventListener('click', toggleCall);

            // Получаем ID пользователя после инициализации Mini App
            tg.onEvent('mainButtonClicked', () => {
                console.log('ID пользователя Telegram (mainButtonClicked):', tg.initDataUnsafe.user.id); 
            });

            // Логируем сообщение после инициализации
            logMessage('App initialized. Is Telegram WebApp: ' + (tg.initDataUnsafe.query_id !== undefined));

            // --- ФУНКЦИИ ---

            function toggleCall() {
                if (isCallActive) {
                    endCall();
                } else {
                    startCall();
                }
            }

            function startCall() {
                if (isCallActive) return;

                isCallActive = true;
                callButton.textContent = 'Завершить звонок';
                addMessage('Звонок начат', 'system');

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        currentStream = stream;
                        initializeRecorder(stream);
                        startSilenceDetection(stream);

                        // Получаем ID пользователя после того, как разрешили доступ к микрофону
                        console.log('ID пользователя Telegram (startCall):', tg.initDataUnsafe.user.id); 
                    })
                    .catch(error => {
                        console.error('Error accessing the microphone:', error);
                        addMessage('Ошибка: Не удалось получить доступ к микрофону', 'error');
                        endCall();
                    });
            }

            function endCall() {
                isCallActive = false;
                if (isRecording) {
                    stopRecordingAndSend();
                }
                callButton.textContent = 'Начать звонок';
                addMessage('Звонок завершен', 'system');
                logMessage('Call ended');
                if (tg.initDataUnsafe.query_id !== undefined) { // Проверка, запущена ли Mini App
                    tg.sendData(JSON.stringify({ action: 'endCall' }));
                }

                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }

                // Остановка детектора тишины
                if (silenceDetectionInterval) {
                    clearInterval(silenceDetectionInterval);
                    silenceDetectionInterval = null;
                }
            }

            function resumeListening() {
                if (isCallActive && !isRecording && !isPlayingResponse) { 
                    console.log("Возобновляем прослушивание");
                    initializeRecorder(currentStream);
                    startSilenceDetection(currentStream);
                }
            }

            function startRecording() {
                isRecording = true;
                recorder.startRecording();
                console.log("Запись начата");
            }
        
            function initializeRecorder(stream) {
                recorder = new RecordRTC(stream, {
                    type: 'audio',
                    mimeType: 'audio/wav',
                    recorderType: RecordRTC.StereoAudioRecorder 
                });
            }

            function stopRecordingAndSend() {
                isRecording = false;
                recorder.stopRecording(() => {
                    audioBlob = recorder.getBlob();
                    sendAudioToServer(audioBlob);
                });
                console.log("Запись остановлена, отправка на сервер");
            }

            async function sendAudioToServer(audioBlob) {
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');

                // Получение ID пользователя Telegram (убедитесь, что Mini App инициализирована)
                let telegramUserId = tg.initDataUnsafe ? tg.initDataUnsafe.user.id : null;
                formData.append('telegram_user_id', telegramUserId); 

                try {
                    console.log("Отправка аудио на сервер...");
                    const response = await fetch('http://127.0.0.1:5000/recognize_speech', { 
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    console.log("Получен ответ от сервера. Статус:", response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log("Успешно получен ответ от сервера:", data);

                    document.getElementById('recordingStatus').textContent = data.text || "Получен ответ от сервера";

                    if (data.audio_data) {
                        try {
                            console.log("Попытка воспроизведения аудио ответа...");
                            new URL(data.audio_data); // Проверка валидности URL

                            const audio = new Audio();
                            audio.type = 'audio/mpeg';
                            audio.src = data.audio_data;

                            isPlayingResponse = true; 

                            audio.oncanplaythrough = () => {
                            console.log("Аудио готово к воспроизведению");
                            audio.play().catch(error => {
                                console.error("Ошибка воспроизведения аудио:", error);
                                document.getElementById('recordingStatus').textContent = "Ошибка воспроизведения аудио ответа.";
                                isPlayingResponse = false; 
                                resumeListening(); 
                            });
                            };

                            audio.onended = () => {
                            console.log("Воспроизведение аудио ответа завершено");
                            isPlayingResponse = false; 
                            resumeListening(); 
                            };

                            audio.onerror = (e) => {
                            console.error("Ошибка загрузки аудио:", e);
                            document.getElementById('recordingStatus').textContent = "Ошибка загрузки аудио ответа.";
                            isPlayingResponse = false; 
                            resumeListening(); 
                            };
                        } catch (urlError) {
                            console.error("Некорректный URL аудио данных:", urlError);
                            document.getElementById('recordingStatus').textContent = "Получены некорректные аудио данные от сервера.";
                            resumeListening(); 
                        }
                    } else {
                        console.log("Аудио данные отсутствуют в ответе сервера");
                        resumeListening(); 
                    }
                } catch (error) {
                    console.error('Ошибка отправки аудио на сервер:', error);
                    document.getElementById('recordingStatus').textContent = `Ошибка: ${error.message}`;
                    resumeListening(); 
                }
            }        

            function addMessage(message, type) {
                const messageElement = document.createElement('p');
                messageElement.classList.add(type);
                messageElement.textContent = message;
                display.appendChild(messageElement);
                display.scrollTop = display.scrollHeight;
            }
            
            function logMessage(message) {
                console.log(message);
                if (tg.initDataUnsafe.query_id !== undefined) { // Проверка, запущена ли Mini App
                    tg.sendData(JSON.stringify({action: 'log', message: message}));
                }
            }

            function startSilenceDetection(stream) {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
            
                let silenceStart = null;
                const SILENCE_DURATION = 1000; // 1 секунда тишины
                const NOISE_THRESHOLD = 10; // Уровень шума, ниже которого считается тишиной
            
                function checkSilence() {
                // Проверка, активен ли звонок
                if (!isCallActive) {
                    console.log("Звонок завершен, останавливаем проверку тишины");
                    clearInterval(silenceDetectionInterval);
                    return;
                }
            
                if (isPlayingResponse) {
                    console.log("Воспроизводится ответ, ожидаем...");
                    return;
                }
            
                analyser.getByteFrequencyData(dataArray);
                const average = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;
            
                if (average < NOISE_THRESHOLD) {
                    if (!silenceStart) {
                    silenceStart = Date.now();
                    } else if (Date.now() - silenceStart > SILENCE_DURATION && !isPlayingResponse) { 
                    if (isRecording) {
                        console.log("Обнаружена тишина, останавливаем запись");
                        stopRecordingAndSend();
                        silenceStart = null; 
                    }
                    }
                } else {
                    silenceStart = null; 
                    if (!isRecording && !isPlayingResponse) { 
                    console.log("Обнаружен звук, начинаем запись");
                    startRecording();
                    }
                }
                }
            
                silenceDetectionInterval = setInterval(checkSilence, 100); 
            }
        });
    </script>
</body>
</html>
