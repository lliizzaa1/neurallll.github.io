<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор холодных звонков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/RecordRTC/5.6.2/RecordRTC.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #phone {
            width: 300px;
            height: 600px;
            border: 2px solid var(--tg-theme-button-color, #3390ec);
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: var(--tg-theme-secondary-bg-color, #f0f0f0);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }
        #display {
            width: 100%;
            height: 400px;
            background-color: var(--tg-theme-bg-color, #ffffff);
            border: 1px solid var(--tg-theme-hint-color, #999999);
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
            font-size: 14px;
            line-height: 1.5;
        }
        #display p {
            margin: 5px 0;
            padding: 5px;
            border-radius: 5px;
            max-width: 80%;
        }
        #display p.system {
            background-color: var(--tg-theme-secondary-bg-color, #e6e6e6);
            align-self: center;
            text-align: center;
            font-style: italic;
        }
        #display p.response {
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            align-self: flex-start;
        }
        #display p.user {
            background-color: var(--tg-theme-secondary-bg-color, #e6e6e6);
            align-self: flex-end;
            text-align: right;
        }
        #display p.error {
            background-color: #ff4d4d;
            color: white;
            align-self: center;
            text-align: center;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            cursor: pointer;
            transition: background-color 0.3s;
        }
        button:hover {
            background-color: var(--tg-theme-secondary-bg-color, #2980b9);
        }
    </style>
</head>
<body>
    <div id="phone">
        <div id="display">
            <p id="recordingStatus"></p> 
        </div> 
        <button id="callButton">Начать звонок</button>
    </div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            let tg = window.Telegram.WebApp;
            let callButton = document.getElementById('callButton');
            let display = document.getElementById('display');
            let isCallActive = false;
            let recorder;
            let audioBlob;
            let isRecording = false;
            let silenceTimer;
            let isPlayingResponse = false;
            let silenceDetectionInterval;
            let currentStream; 
            const urlParams = new URLSearchParams(window.location.search);
            const userId = urlParams.get('user_id');
            console.log('URL:', urlParams);
            console.log('ID пользователя из URL:', userId);

            const SILENCE_THRESHOLD = 1000; // 1 секунда тишины

            // Флаг, указывающий, обрабатывается ли запрос
            let isProcessingRequest = false;

            // Инициализация Telegram Mini App
            tg.ready();

            // Обработчик нажатия на кнопку "Начать звонок"
            callButton.addEventListener('click', toggleCall);

            // Логируем сообщение после инициализации
            logMessage('App initialized. Is Telegram WebApp: ' + (tg.initData.query_id !== undefined));

            // --- ФУНКЦИИ ---

            function toggleCall() {
                if (isCallActive) {
                    endCall();
                } else {
                    startCall();
                }
            }

            function startCall() {
                if (isCallActive) return;

                isCallActive = true;
                callButton.textContent = 'Завершить звонок';
                addMessage('Звонок начат', 'system');

                const personCharacteristics = generatePersonCharacteristics();
                console.log("Сгенерированные характеристики:", personCharacteristics); 

                navigator.mediaDevices.getUserMedia({ audio: true })
                    .then(stream => {
                        currentStream = stream;
                        initializeRecorder(stream);
                        startSilenceDetection(stream);
                    })
                    .catch(error => {
                        console.error('Error accessing the microphone:', error);
                        addMessage('Ошибка: Не удалось получить доступ к микрофону', 'error');
                        endCall();
                    });
            }

            function endCall() {
                isCallActive = false;
                if (isRecording) {
                    stopRecordingAndSend();
                }
                callButton.textContent = 'Начать звонок';
                addMessage('Звонок завершен', 'system');
                logMessage('Call ended');
                if (tg.initData.query_id !== undefined) {
                    tg.sendData(JSON.stringify({ action: 'endCall' }));
                }

                if (silenceTimer) {
                    clearTimeout(silenceTimer);
                    silenceTimer = null;
                }

                if (silenceDetectionInterval) {
                    clearInterval(silenceDetectionInterval);
                    silenceDetectionInterval = null;
                }

                deleteConversation();
            }

            function resumeListening() {
                if (isCallActive && !isRecording && !isPlayingResponse) { 
                    console.log("Возобновляем прослушивание");
                    initializeRecorder(currentStream);
                    startSilenceDetection(currentStream);
                }
            }

            function startRecording() {
                isRecording = true;
                recorder.startRecording();
                console.log("Запись начата");
            }

            function initializeRecorder(stream) {
                recorder = new RecordRTC(stream, {
                    type: 'audio',
                    mimeType: 'audio/wav',
                    recorderType: RecordRTC.StereoAudioRecorder 
                });
            }

            function stopRecordingAndSend() {
                isRecording = false;
                recorder.stopRecording(() => {
                    audioBlob = recorder.getBlob();
                    sendAudioToServer(audioBlob);
                });
                console.log("Запись остановлена, отправка на сервер");
            }

            async function sendAudioToServer(audioBlob) {
                if (isProcessingRequest) { 
                    console.log("Предыдущий запрос еще обрабатывается.");
                    return; 
                }

                isProcessingRequest = true; 
                const formData = new FormData();
                formData.append('audio', audioBlob, 'recording.wav');
                formData.append('characteristics', JSON.stringify(personCharacteristics));

                if (userId) {
                    formData.append('telegram_user_id', userId);
                } else {
                    console.error("Ошибка: userId не определен");
                }

                try {
                    console.log("Отправка аудио на сервер...");
                    const response = await fetch('http://127.0.0.1:5000/recognize_speech', { 
                        method: 'POST',
                        body: formData
                    });

                    console.log("Получен ответ от сервера. Статус:", response.status);

                    if (!response.ok) {
                        const errorText = await response.text();
                        throw new Error(`HTTP error! status: ${response.status}, message: ${errorText}`);
                    }

                    const data = await response.json();
                    console.log("Успешно получен ответ от сервера:", data);

                    document.getElementById('recordingStatus').textContent = data.text || "Получен ответ от сервера";

                    if (data.audio_data) {
                        try {
                            console.log("Попытка воспроизведения аудио ответа...");
                            new URL(data.audio_data); 

                            const audio = new Audio();
                            audio.type = 'audio/mpeg';
                            audio.src = data.audio_data;

                            isPlayingResponse = true; 

                            audio.oncanplaythrough = () => {
                                console.log("Аудио готово к воспроизведению");
                                audio.play().catch(error => {
                                    console.error("Ошибка воспроизведения аудио:", error);
                                    document.getElementById('recordingStatus').textContent = "Ошибка воспроизведения аудио ответа.";
                                    isPlayingResponse = false; 
                                    resumeListening(); 
                                });
                            };

                            audio.onended = () => {
                                console.log("Воспроизведение аудио ответа завершено");
                                isPlayingResponse = false; 
                                resumeListening(); 
                            };

                            audio.onerror = (e) => {
                                console.error("Ошибка загрузки аудио:", e);
                                document.getElementById('recordingStatus').textContent = "Ошибка загрузки аудио ответа.";
                                isPlayingResponse = false; 
                                resumeListening(); 
                            };
                        } catch (urlError) {
                            console.error("Некорректный URL аудио данных:", urlError);
                            document.getElementById('recordingStatus').textContent = "Получены некорректные аудио данные от сервера.";
                            resumeListening(); 
                        }
                    } else {
                        console.log("Аудио данные отсутствуют в ответе сервера");
                        resumeListening(); 
                    }
                } catch (error) {
                    console.error('Ошибка отправки аудио на сервер:', error);
                    document.getElementById('recordingStatus').textContent = `Ошибка: ${error.message}`;
                    resumeListening(); 
                } finally {
                    isProcessingRequest = false; 
                }
            }        

            function addMessage(message, type) {
                const messageElement = document.createElement('p');
                messageElement.classList.add(type);
                messageElement.textContent = message;
                display.appendChild(messageElement);
                display.scrollTop = display.scrollHeight;
            }
            
            function logMessage(message) {
                console.log(message);
                if (tg.initData.query_id !== undefined) { 
                    tg.sendData(JSON.stringify({action: 'log', message: message}));
                }
            }

            function getRandomInt(min, max) {
                return Math.floor(Math.random() * (max - min + 1)) + min;
            }
            
            // Функция для получения случайного элемента из массива
            function getRandomElement(array) {
                return array[getRandomInt(0, array.length - 1)];
            }
            
            function generatePersonCharacteristics() {
                const characteristics = {
                    "пол": getRandomElement(["Мужской", "Женский"]),
                    "уровень_дохода": getRandomElement([
                        "Низкий (до 30 000 руб/мес)",
                        "Ниже среднего (30 000 - 50 000 руб/мес)",
                        "Средний (50 000 - 100 000 руб/мес)",
                        "Выше среднего (100 000 - 200 000 руб/мес)",
                        "Высокий (200 000 - 500 000 руб/мес)",
                        "Очень высокий (более 500 000 руб/мес)"
                    ]),
                    "профессия": getRandomElement([
                        "IT-специалист", "Врач", "Учитель", "Инженер", "Менеджер", "Предприниматель", 
                        "Юрист", "Бухгалтер", "Продавец", "Строитель", "Водитель", 
                        "Работник сферы услуг", "Государственный служащий", "Военнослужащий", 
                        "Пенсионер", "Студент"
                    ]),
                    "семейное_положение": getRandomElement([
                        "Холост/не замужем", "Женат/замужем", "В разводе", "Вдовец/вдова", "В гражданском браке"
                    ]),
                    "дети": getRandomElement([
                        "Нет детей", "1 ребенок", "2 детей", "3 детей", "4 и более детей"
                    ]),
                    "образование": getRandomElement([
                        "Среднее", "Среднее специальное", "Неоконченное высшее", "Высшее", 
                        "Несколько высших образований", "Ученая степень"
                    ]),
                    "регион": getRandomElement([
                        "Москва", "Санкт-Петербург", "Центральный федеральный округ", "Северо-Западный федеральный округ", 
                        "Южный федеральный округ", "Северо-Кавказский федеральный округ", "Приволжский федеральный округ", 
                        "Уральский федеральный округ", "Сибирский федеральный округ", "Дальневосточный федеральный округ"
                    ]),
                    "жилье": getRandomElement([
                        "Собственная квартира", "Собственный дом", "Съемная квартира", "Съемный дом", 
                        "Комната в общежитии", "Живет с родителями"
                    ]),
                    "опыт_инвестирования": getRandomElement([
                        "Новичок (нет опыта)", "Начинающий (менее 1 года)", "Средний (1-3 года)", 
                        "Опытный (3-5 лет)", "Эксперт (более 5 лет)"
                    ]),
                    "отношение_к_риску": getRandomElement([
                        "Консервативный", "Умеренно-консервативный", "Сбалансированный", "Умеренно-агрессивный", "Агрессивный"
                    ]),
                    "цели": getRandomElement([
                        "Накопление на пенсию", "Покупка недвижимости", "Образование детей", 
                        "Создание финансовой подушки безопасности", "Получение пассивного дохода", 
                        "Путешествия", "Покупка автомобиля", "Открытие бизнеса"
                    ]),
                    "хобби": getRandomElement([
                        "Спорт", "Чтение", "Путешествия", "Кулинария", "Рыбалка/охота", "Садоводство", 
                        "Фотография", "Музыка", "Искусство", "Компьютерные игры", "Рукоделие", 
                        "Коллекционирование", "Волонтерство"
                    ]),
                    "темперамент": getRandomElement([
                        "Холерик", "Сангвиник", "Флегматик", "Меланхолик"
                    ]),
                    "занятость": getRandomElement([
                        "Очень занят (менее 1 часа свободного времени в день)", 
                        "Занят (1-2 часа свободного времени в день)", 
                        "Средняя занятость (2-4 часа свободного времени в день)", 
                        "Много свободного времени (более 4 часов в день)", 
                        "Безработный/в поиске работы"
                    ]),
                    "коммуникация_предпочитаемая": getRandomElement([
                        "Телефонные звонки", "Email", "WhatsApp", "Telegram", "Viber", "SMS", "Личные встречи"
                    ]),
                    "отноешение_к_технологиям": getRandomElement([
                        "Технофоб (избегает новых технологий)", "Консерватор (использует только проверенные технологии)", 
                        "Умеренный пользователь (открыт к новому, но осторожен)", "Энтузиаст (активно использует новые технологии)", 
                        "Ранний последователь (всегда в курсе последних новинок)"
                    ]),
                    "кредитная_история": getRandomElement([
                        "Отличная (всегда вовремя погашает кредиты)", "Хорошая (редкие задержки платежей)", "Средняя (бывают просрочки)", 
                        "Плохая (есть непогашенные кредиты)", "Отсутствует (никогда не брал кредиты)"
                    ]),
                    "сбережения": getRandomElement([
                        "Нет сбережений", "Минимальные сбережения (до 50 000 руб)", "Средние сбережения (50 000 - 300 000 руб)", 
                        "Значительные сбережения (300 000 - 1 000 000 руб)", "Крупные сбережения (более 1 000 000 руб)"
                    ]),
                    "уровень_знаний_в_области_финансов": getRandomElement([
                        "Низкое (знает только о вкладах)", "Базовое (знает о вкладах и кредитах)", 
                        "Среднее (знает о вкладах, кредитах, акциях и облигациях)", 
                        "Высокое (разбирается в большинстве финансовых инструментов)", 
                        "Экспертное (глубокое понимание финансовых рынков)"
                    ]),
                    "опыт_с_компаниями": getRandomElement([
                        "Нет опыта", "Негативный опыт", "Нейтральный опыт", "Позитивный опыт", 
                        "Смешанный опыт (и позитивный, и негативный)"
                    ]),
                    "психологический_портрет": getRandomElement([
                        "Открытость новому", "Скептицизм", "Импульсивность", "Осторожность", 
                        "Аналитический склад ума", "Эмоциональность", "Рациональность", 
                        "Склонность к прокрастинации", "Решительность", "Нерешительность", 
                        "Стрессоустойчивость", "Перфекционизм"
                    ])
                };
            
                return characteristics; 
            }

            async function deleteConversation() {
                const formData = new FormData();
                formData.append('telegram_user_id', userId); 
            
                try {
                    const response = await fetch('http://127.0.0.1:5000/delete_conversation', {
                        method: 'POST',
                        body: formData
                    });
            
                    if (response.ok) {
                        console.log('Conversation deleted successfully');
                    } else {
                        console.error('Error deleting conversation:', response.status);
                    }
                } catch (error) {
                    console.error('Error deleting conversation:', error);
                }
            }

            function startSilenceDetection(stream) {
                const audioContext = new AudioContext();
                const analyser = audioContext.createAnalyser();
                const microphone = audioContext.createMediaStreamSource(stream);
                microphone.connect(analyser);
                analyser.fftSize = 2048;
                const bufferLength = analyser.frequencyBinCount;
                const dataArray = new Uint8Array(bufferLength);
            
                let silenceStart = null;
                const SILENCE_DURATION = 1000; // 1 секунда тишины
                const NOISE_THRESHOLD = 10; // Уровень шума, ниже которого считается тишиной
            
                function checkSilence() {
                    if (!isCallActive) {
                        console.log("Звонок завершен, останавливаем проверку тишины");
                        clearInterval(silenceDetectionInterval);
                        return;
                    }
            
                    if (isPlayingResponse) {
                        console.log("Воспроизводится ответ, ожидаем...");
                        return;
                    }
            
                    analyser.getByteFrequencyData(dataArray);
                    const average = dataArray.reduce((sum, value) => sum + value, 0) / bufferLength;
            
                    if (average < NOISE_THRESHOLD) {
                        if (!silenceStart) {
                            silenceStart = Date.now();
                        } else if (Date.now() - silenceStart > SILENCE_DURATION && !isPlayingResponse) { 
                            if (isRecording) {
                                console.log("Обнаружена тишина, останавливаем запись");
                                stopRecordingAndSend();
                                silenceStart = null; 
                            }
                        }
                    } else {
                        silenceStart = null; 
                        if (!isRecording && !isPlayingResponse) { 
                            console.log("Обнаружен звук, начинаем запись");
                            startRecording();
                        }
                    }
                }
            
                silenceDetectionInterval = setInterval(checkSilence, 100); 
            }

        });
    </script>
</body>
</html>
