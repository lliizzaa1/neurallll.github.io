<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Симулятор холодных звонков</title>
    <script src="https://telegram.org/js/telegram-web-app.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            display: flex;
            justify-content: center;
            align-items: center;
            height: 100vh;
            margin: 0;
            background-color: var(--tg-theme-bg-color, #ffffff);
            color: var(--tg-theme-text-color, #000000);
        }
        #phone {
            width: 300px;
            height: 600px;
            border: 2px solid black;
            border-radius: 20px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            padding: 20px;
            background-color: #f0f0f0;
        }
        #display {
            width: 100%;
            height: 400px;
            background-color: white;
            border: 1px solid #ccc;
            overflow-y: auto;
            padding: 10px;
            margin-bottom: 20px;
        }
        button {
            padding: 10px 20px;
            font-size: 16px;
            background-color: var(--tg-theme-button-color, #3390ec);
            color: var(--tg-theme-button-text-color, #ffffff);
            border: none;
            border-radius: 5px;
            cursor: pointer;
        }
    </style>
</head>
<body>
    <div id="phone">
        <div id="display"></div>
        <button id="callButton">Начать звонок</button>
    </div>

    <script>
        function initApp() {
            let tg = window.Telegram.WebApp;
            let callButton = document.getElementById('callButton');
            let display = document.getElementById('display');
            let isCallActive = false;
            let intervalId;
            let isTelegramWebApp = tg.initDataUnsafe.query_id !== undefined;

            console.log('Is Telegram WebApp:', isTelegramWebApp);

            tg.expand();

            callButton.addEventListener('click', toggleCall);

            function toggleCall() {
                if (isCallActive) {
                    endCall();
                } else {
                    startCall();
                }
            }

            function startCall() {
                isCallActive = true;
                callButton.textContent = 'Завершить звонок';
                display.innerHTML += '<p>Звонок начат.</p>';
                intervalId = setInterval(getResponse, 3000);
                if (isTelegramWebApp) {
                    tg.showAlert("Звонок начат");
                }
            }

            function endCall() {
                isCallActive = false;
                callButton.textContent = 'Начать звонок';
                display.innerHTML += '<p>Звонок завершен</p>';
                clearInterval(intervalId);
                if (isTelegramWebApp) {
                    tg.showAlert("Звонок завершен");
                }
            }

            function getResponse() {
                if (isTelegramWebApp) {
                    // Для Telegram WebApp используем предопределенный список ответов
                    let responses = [
                        "Здравствуйте, чем могу помочь?",
                        "Интересно, расскажите подробнее.",
                        "А какие преимущества у вашего предложения?",
                        "Сколько это будет стоить?",
                        "Звучит неплохо, но мне нужно подумать.",
                        "У нас уже есть поставщик. Чем ваше предложение лучше?",
                        "Отправьте, пожалуйста, информацию на email.",
                        "Я не принимаю решения по таким вопросам. Обратитесь к моему руководителю.",
                        "Спасибо за информацию, я подумаю над вашим предложением.",
                        "Хорошо, давайте созвонимся на следующей неделе.",
                        "Извините, но мне это не интересно. Всего доброго.",
                    ];
                    let response = responses[Math.floor(Math.random() * responses.length)];
                    display.innerHTML += `<p>Собеседник: ${response}</p>`;
                    display.scrollTop = display.scrollHeight;
                } else {
                    // Для браузера используем запрос к локальному серверу
                    fetch('http://127.0.0.1:5000/get_response')
                        .then(response => response.json())
                        .then(data => {
                            display.innerHTML += `<p>Собеседник: ${data.response}</p>`;
                            display.scrollTop = display.scrollHeight;
                        })
                        .catch(error => {
                            console.error('Error:', error);
                            display.innerHTML += '<p>Ошибка при получении ответа</p>';
                        });
                }
            }

            if (!isTelegramWebApp) {
                testServer();
            }

            function testServer() {
                fetch('http://127.0.0.1:5000/test')
                    .then(response => response.json())
                    .then(data => {
                        console.log('Server test:', data);
                        display.innerHTML += `<p>Тест сервера: ${data.message}</p>`;
                    })
                    .catch(error => {
                        console.error('Server test error:', error);
                        display.innerHTML += '<p>Ошибка при тестировании сервера</p>';
                    });
            }

            tg.ready();
        }

        initApp();
    </script>
</body>
</html>
